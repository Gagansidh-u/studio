<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Invoice Generator | Next Analytics</title>
  <!-- jsPDF and AutoTable -->
  <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf-autotable/3.5.29/jspdf.plugin.autotable.min.js"></script>
</head>
<body style="font-family: Arial, sans-serif; text-align: center; margin-top: 50px;">
  <h2>Next Analytics Invoice Generator</h2>
  <p>Click the button below to generate an invoice PDF.</p>
  <button id="generateBtn" style="padding: 10px 20px; font-size: 16px; cursor: pointer;">Generate Invoice</button>

  <script>
    // --- Helper function to format date ---
    function formatDate(date) {
      const options = { year: 'numeric', month: 'short', day: '2-digit' };
      return date.toLocaleDateString('en-US', options);
    }

    // --- Helper function to load logo ---
    function loadImage(url) {
      return new Promise((resolve, reject) => {
        const img = new Image();
        img.crossOrigin = "Anonymous";
        img.onload = () => resolve(img);
        img.onerror = reject;
        img.src = url;
      });
    }

    // --- Your main invoice generator ---
    async function generateInvoice(data) {
      const { jsPDF } = window.jspdf;
      const doc = new jsPDF();

      const date = new Date();
      const formattedDate = formatDate(date);
      const invoiceNumber = data.orderId.startsWith("FREE-")
        ? data.orderId.slice(5, 13).toUpperCase()
        : data.orderId.slice(-8).toUpperCase();

      const logoUrl = "https://via.placeholder.com/100x100.png?text=Next+Analytics";

      // Header with Logo
      try {
        const logoImage = await loadImage(logoUrl);
        doc.addImage(logoImage, "PNG", 14, 15, 10, 10);
      } catch (err) {
        console.warn("Logo not loaded:", err);
      }

      doc.setFontSize(22);
      doc.setFont("helvetica", "bold");
      doc.text("Next Analytics", 28, 22);

      doc.setFontSize(10);
      doc.text("Barnala, Punjab, India", 14, 32);
      doc.text("Nextanalytics@outlook.com", 14, 38);
      doc.text("nextanalytics.store", 14, 44);

      doc.setFontSize(18);
      doc.setFont("helvetica", "bold");
      doc.text("INVOICE", 190, 22, { align: "right" });

      // Bill To
      doc.setFontSize(11);
      doc.setFont("helvetica", "bold");
      doc.text("Bill To:", 14, 58);
      doc.setFont("helvetica", "normal");
      doc.text(data.customer.name, 14, 64);
      doc.text(data.customer.email, 14, 70);

      // Invoice details
      doc.setFontSize(11);
      doc.setFont("helvetica", "bold");
      doc.text("Invoice Number:", 130, 58);
      doc.text("Invoice Date:", 130, 64);
      doc.text("Order ID:", 130, 70);
      if (!data.paymentId.startsWith("FREE-")) doc.text("Payment ID:", 130, 76);

      doc.setFont("helvetica", "normal");
      doc.text(invoiceNumber, 190, 58, { align: "right" });
      doc.text(formattedDate, 190, 64, { align: "right" });
      doc.text(data.orderId, 190, 70, { align: "right" });
      if (!data.paymentId.startsWith("FREE-"))
        doc.text(data.paymentId, 190, 76, { align: "right" });

      // Table
      const tableColumn = ["Description", "Price", "Discount", "Subtotal"];
      const subtotalBeforeGst = data.coupon.isPay1
        ? 1 / 1.18
        : data.plan.price - data.coupon.discount;

      const tableRows = [
        [
          data.plan.name,
          `Rs. ${data.plan.price.toFixed(2)}`,
          data.coupon.code === "25072005" || data.coupon.discount === data.plan.price
            ? "100% OFF"
            : `Rs. ${data.coupon.discount.toFixed(2)}`,
          `Rs. ${subtotalBeforeGst.toFixed(2)}`
        ]
      ];

      doc.autoTable({
        startY: 85,
        head: [tableColumn],
        body: tableRows,
        theme: "striped",
        styles: { font: "helvetica", fontSize: 10 },
        headStyles: { fillColor: [0, 128, 128], textColor: 255, fontStyle: "bold" },
        didParseCell(data) {
          if (data.column.index > 0 && data.section === "body") {
            data.cell.styles.halign = "right";
          }
        }
      });

      // Totals
      const finalY = doc.lastAutoTable.finalY;
      const totalsRows = [["Subtotal:", `Rs. ${subtotalBeforeGst.toFixed(1)}`]];
      if (data.gst > 0) totalsRows.push(["GST (18%):", `Rs. ${data.gst.toFixed(1)}`]);
      totalsRows.push([
        { content: "Total:", styles: { fontStyle: "bold" } },
        { content: `Rs. ${data.total.toFixed(1)}`, styles: { fontStyle: "bold" } }
      ]);

      doc.autoTable({
        startY: finalY + 8,
        body: totalsRows,
        theme: "plain",
        tableWidth: "wrap",
        margin: { left: 130 },
        styles: { font: "helvetica", fontSize: 10 },
        columnStyles: {
          0: { fontStyle: "bold", halign: "right" },
          1: { halign: "right" }
        },
        didParseCell(data) {
          if (data.row.index === totalsRows.length - 1)
            data.cell.styles.fontSize = 12;
        }
      });

      // Footer
      doc.setFontSize(10);
      doc.text("Thank you for your business!", 14, doc.internal.pageSize.height - 20);
      doc.text(
        "This is a system-generated invoice and does not require a signature.",
        105,
        doc.internal.pageSize.height - 10,
        { align: "center" }
      );

      doc.save(`Invoice-${invoiceNumber}.pdf`);
    }

    // Example Data + Button Click
    document.getElementById("generateBtn").addEventListener("click", () => {
      const sampleData = {
        orderId: "ORD-12345678",
        paymentId: "PAY-987654321",
        customer: { name: "Dhwanil Singh", email: "dhwanil@example.com" },
        plan: { name: "Premium Analytics Plan", price: 999 },
        coupon: { code: "25072005", discount: 0, isPay1: false },
        gst: 179.82,
        total: 1178.82
      };
      generateInvoice(sampleData);
    });
  </script>
</body>
</html>